---
# Phase 6: Publish changes (branch -> commit -> push)
# Only runs for repositories that changed in Phase 4.

- name: Publish | set safe defaults
  ansible.builtin.set_fact:
    changed_repos: "{{ changed_repos | default([]) }}"
    changed_targets_by_repo: "{{ changed_targets_by_repo | default({}) }}"

- name: Publish | detect dirty repos in workspace
  ansible.builtin.shell: |
    set -euo pipefail
    repo_dir="{{ item }}"
    if git -C "$repo_dir" status --porcelain | grep -q .; then
      echo "{{ item }}"
    fi
  args:
    executable: /bin/bash
  loop: "{{ repos_with_targets | default([]) }}"
  register: dirty_check
  changed_when: false

- name: Publish | set changed_repos from dirty repos (git status)
  ansible.builtin.set_fact:
    changed_repos: "{{ dirty_check.results | map(attribute='stdout') | map('trim') | reject('equalto','') | list }}"


- name: Publish | skip if nothing changed
  ansible.builtin.debug:
    msg: "No changed repositories. Publish phase will be skipped."
  when: changed_repos | length == 0

# Write per-repo file lists so we can stage only those files without complex inline code
- name: Publish | write changed file list per repo (for staging)
  ansible.builtin.copy:
    dest: "{{ item }}/.repo_orch_changed_files"
    mode: "0644"
    content: |
      {% for f in (changed_targets_by_repo[item] | default([])) %}
      {{ f }}
      {% endfor %}
  loop: "{{ changed_repos }}"
  when: changed_repos | length > 0

- name: Publish | branch, commit, and push per changed repo
  ansible.builtin.shell: |
    set -euo pipefail

    repo_dir="{{ item }}"
    branch="{{ git.branch_name }}"

    echo "==> REPO: $repo_dir"

    # Determine default branch from origin
    default_branch="$(git -C "$repo_dir" remote show origin | sed -n '/HEAD branch/s/.*: //p')"
    if [ -z "$default_branch" ]; then
      echo "ERROR: Could not determine default branch for $repo_dir"
      exit 2
    fi
    echo "Default branch: $default_branch"

    # Sync default branch
    git -C "$repo_dir" checkout "$default_branch"
    git -C "$repo_dir" pull --ff-only

    # Create/reset branch from default
    git -C "$repo_dir" checkout -B "$branch"

    # Stage only changed targets if list exists and is non-empty; otherwise stage all changes

    # Stage only known target files for this repo (robust)
    git -C "$repo_dir" add -- Dockerfile || true
    git -C "$repo_dir" add -A


    # Commit & push only if there are changes
    if git -C "$repo_dir" status --porcelain | grep -q .; then
      git -C "$repo_dir" commit -m "{{ git.commit_message }}"
      git -C "$repo_dir" push -u origin "$branch"
      echo "PUSHED: $branch"
    else
      echo "NOOP: nothing to commit"
    fi
  args:
    executable: /bin/bash
  loop: "{{ changed_repos }}"
  register: publish_run
  when: changed_repos | length > 0

- name: Publish | write publish.json (pretty)
  ansible.builtin.copy:
    dest: "{{ paths.reports }}/publish.json"
    mode: "0644"
    content: "{{ publish_run | to_nice_json }}\n"

- name: Publish | cleanup temporary staging files
  ansible.builtin.file:
    path: "{{ item }}/.repo_orch_changed_files"
    state: absent
  loop: "{{ changed_repos }}"
  when: changed_repos | length > 0

- name: Publish | debug publish completion
  ansible.builtin.debug:
    msg: "Publish phase finished. See {{ paths.reports }}/publish.json"
  when: changed_repos | length > 0
